// Churchill Application Portal - Database Schema
// Version: 3.1
// Last Updated: November 17, 2025
// Architecture: Lean JSONB-first approach (16 tables)
// Tool: dbdiagram.io

Project ApplicationPortal {
  database_type: 'PostgreSQL'
  Note: '''
    # Churchill Application Portal Schema
    
    **Total Tables:** 16 (reduced from 34 for MVP)
    **Architecture:** JSONB-first for rapid iteration
    **Multi-tenancy:** RTO-based isolation
    
    ## Key JSONB Fields
    - APPLICATION: 10 JSONB fields (enrollment_data, emergency_contacts, health_cover_policy, disability_support, language_cultural_data, survey_responses, additional_services, gs_assessment, signature_data, form_metadata)
    - USER_ACCOUNT: 2 JSONB fields (notification_preferences, admin_config)
    - DOCUMENT: 1 JSONB field (gs_document_requests)
    - TIMELINE_ENTRY: 1 JSONB field (event_payload)
    - RTO_PROFILE: 3 JSONB fields (address, brand_settings, business_settings)
  '''
}

// ============================================================================
// CORE IDENTITY & ORGANIZATION
// ============================================================================

Table rto_profile {
  id uuid [pk, not null, default: `gen_random_uuid()`]
  name varchar(255) [not null]
  abn varchar(11) [unique, not null]
  cricos_code varchar(10) [unique]
  contact_email varchar(255) [not null]
  contact_phone varchar(50)
  address jsonb [note: 'Street, city, state, postcode, country']
  logo_url text
  brand_settings jsonb [note: 'Primary color, secondary color, fonts, email templates']
  business_settings jsonb [note: 'Default commission rates, SLA targets, workflow config']
  is_active boolean [not null, default: true]
  created_at timestamp [not null, default: `now()`]
  updated_at timestamp [not null, default: `now()`]
  
  indexes {
    abn [unique]
    cricos_code [unique]
    is_active
  }
  
  Note: 'RTO/Organization profile for multi-tenancy. Contains branding and business configuration.'
}

Table user_account {
  id uuid [pk, not null, default: `gen_random_uuid()`]
  email varchar(255) [unique, not null]
  password_hash varchar(255) [not null]
  role varchar(20) [not null, note: 'STUDENT, AGENT, STAFF, ADMIN']
  rto_profile_id uuid [not null, ref: > rto_profile.id]
  mfa_enabled boolean [not null, default: false]
  mfa_secret varchar(255)
  status varchar(20) [not null, default: 'active', note: 'active, inactive, suspended']
  last_login_at timestamp
  notification_preferences jsonb [note: 'Email, SMS, in-app notification settings']
  admin_config jsonb [note: 'Workflow SLA targets, default templates (for STAFF/ADMIN only)']
  created_at timestamp [not null, default: `now()`]
  updated_at timestamp [not null, default: `now()`]
  
  indexes {
    email [unique]
    rto_profile_id
    role
    status
    (notification_preferences) [type: gin, name: 'idx_user_notification_prefs']
    (admin_config) [type: gin, name: 'idx_user_admin_config']
  }
  
  Note: 'Unified user authentication across all roles. Role determines which profile table to join.'
}

Table agent_profile {
  id uuid [pk, not null, default: `gen_random_uuid()`]
  user_account_id uuid [unique, not null, ref: - user_account.id]
  agency_name varchar(255) [not null]
  phone varchar(50)
  address text
  commission_rate decimal(5,2) [note: 'e.g., 15.00 for 15%']
  created_at timestamp [not null, default: `now()`]
  
  indexes {
    user_account_id [unique]
  }
  
  Note: 'Agent-specific profile. One-to-one with user_account where role=AGENT.'
}

Table staff_profile {
  id uuid [pk, not null, default: `gen_random_uuid()`]
  user_account_id uuid [unique, not null, ref: - user_account.id]
  department varchar(100)
  job_title varchar(100)
  permissions jsonb [note: 'Granular permission flags for staff features']
  created_at timestamp [not null, default: `now()`]
  
  indexes {
    user_account_id [unique]
  }
  
  Note: 'Staff-specific profile. One-to-one with user_account where role=STAFF or ADMIN.'
}

Table student_profile {
  id uuid [pk, not null, default: `gen_random_uuid()`]
  user_account_id uuid [unique, not null, ref: - user_account.id]
  given_name varchar(100) [not null]
  family_name varchar(100) [not null]
  date_of_birth date [not null]
  passport_number varchar(50)
  nationality varchar(100) [not null]
  visa_type varchar(50)
  phone varchar(50)
  address text
  created_at timestamp [not null, default: `now()`]
  
  indexes {
    user_account_id [unique]
    (given_name, family_name)
    passport_number
  }
  
  Note: 'Student-specific profile. One-to-one with user_account where role=STUDENT.'
}

// ============================================================================
// COURSE CATALOG
// ============================================================================

Table course_offering {
  id uuid [pk, not null, default: `gen_random_uuid()`]
  course_code varchar(50) [unique, not null]
  course_name varchar(255) [not null]
  intake varchar(100) [not null, note: 'e.g., 2025 Semester 1']
  campus varchar(100) [not null]
  tuition_fee decimal(10,2) [not null]
  application_deadline date
  is_active boolean [not null, default: true]
  created_at timestamp [not null, default: `now()`]
  
  indexes {
    course_code [unique]
    is_active
    intake
  }
  
  Note: 'Course catalog with intake periods. Pre-seeded with Churchill courses.'
}

// ============================================================================
// APPLICATION CORE (HEAVY JSONB USAGE)
// ============================================================================

Table application {
  id uuid [pk, not null, default: `gen_random_uuid()`]
  student_profile_id uuid [not null, ref: > student_profile.id]
  agent_profile_id uuid [ref: > agent_profile.id, note: 'Optional - direct applications']
  course_offering_id uuid [not null, ref: > course_offering.id]
  current_stage varchar(30) [not null, default: 'draft', note: 'DRAFT, SUBMITTED, STAFF_REVIEW, DOCUMENT_VERIFICATION, GS_INTERVIEW, OFFER_GENERATED, OFFER_SIGNED, ENROLLED, etc.']
  assigned_staff_id uuid [ref: > staff_profile.id]
  submitted_at timestamp
  decision_at timestamp
  
  // USI fields (normalized for frequent queries)
  usi varchar(10) [unique]
  usi_verified boolean [not null, default: false]
  usi_verified_at timestamp
  
  // JSONB fields (consolidated from 19 tables)
  enrollment_data jsonb [note: 'Status, offer_signed_at, fee_received_at, coe_uploaded_at (replaces COURSE_ENROLLMENT table)']
  emergency_contacts jsonb [note: 'Array of contact objects with name, relationship, phone, email (replaces EMERGENCY_CONTACT table)']
  health_cover_policy jsonb [note: 'Provider, policy_number, start_date, end_date, coverage_type (replaces HEALTH_COVER_POLICY table)']
  disability_support jsonb [note: 'has_disability, disability_details, support_required, documentation_status (replaces DISABILITY_SUPPORT table)']
  language_cultural_data jsonb [note: 'first_language, other_languages, indigenous_status, country_of_birth, citizenship_status (replaces LANGUAGE_CULTURAL_PROFILE table)']
  survey_responses jsonb [note: 'Array of question/answer pairs (replaces SURVEY_QUESTION + SURVEY_RESPONSE tables)']
  additional_services jsonb [note: 'Array of selected services with fees (replaces ADDITIONAL_SERVICE + APPLICATION_ADDITIONAL_SERVICE tables)']
  gs_assessment jsonb [note: 'GS interview scorecard, decision, notes (replaces GS_ASSESSMENT table)']
  signature_data jsonb [note: 'DocuSeal envelope data, parties, signatures (replaces SIGNATURE_ENVELOPE + SIGNATURE_PARTY tables)']
  form_metadata jsonb [note: 'UI state: version, completed_sections, auto_save_count, last_saved_at']
  
  created_at timestamp [not null, default: `now()`]
  updated_at timestamp [not null, default: `now()`]
  
  indexes {
    student_profile_id
    agent_profile_id
    course_offering_id
    current_stage
    assigned_staff_id
    submitted_at
    usi [unique]
    (enrollment_data) [type: gin, name: 'idx_application_enrollment']
    (emergency_contacts) [type: gin, name: 'idx_application_emergency']
    (health_cover_policy) [type: gin, name: 'idx_application_health_cover']
    (disability_support) [type: gin, name: 'idx_application_disability']
    (language_cultural_data) [type: gin, name: 'idx_application_language']
    (survey_responses) [type: gin, name: 'idx_application_survey']
    (additional_services) [type: gin, name: 'idx_application_services']
    (gs_assessment) [type: gin, name: 'idx_application_gs_assessment']
    (signature_data) [type: gin, name: 'idx_application_signatures']
  }
  
  Note: '''
    Central application record with extensive JSONB fields for MVP flexibility.
    10 JSONB fields consolidate 19 former normalized tables.
    GIN indexes enable efficient querying on JSONB content.
  '''
}

Table application_stage_history {
  id uuid [pk, not null, default: `gen_random_uuid()`]
  application_id uuid [not null, ref: > application.id]
  from_stage varchar(30) [not null]
  to_stage varchar(30) [not null]
  changed_by uuid [not null, ref: > user_account.id]
  changed_at timestamp [not null, default: `now()`]
  notes text
  
  indexes {
    application_id
    changed_at
    (application_id, changed_at)
  }
  
  Note: 'Immutable audit trail of workflow transitions. Required for SLA reporting.'
}

// ============================================================================
// HISTORY LISTS (NORMALIZED FOR FREQUENT QUERIES)
// ============================================================================

Table schooling_history {
  id uuid [pk, not null, default: `gen_random_uuid()`]
  application_id uuid [not null, ref: > application.id]
  institution varchar(255) [not null]
  country varchar(100) [not null]
  start_year integer [not null]
  end_year integer [note: 'NULL if currently enrolled']
  qualification_level varchar(100) [not null, note: 'e.g., Year 12, High School Diploma']
  result varchar(50) [note: 'e.g., 85%, A+, ATAR 90']
  display_order integer [not null, default: 0]
  
  indexes {
    application_id
    country
  }
  
  Note: 'Variable-length list of schools attended. Frequently queried for verification.'
}

Table qualification_history {
  id uuid [pk, not null, default: `gen_random_uuid()`]
  application_id uuid [not null, ref: > application.id]
  qualification_name varchar(255) [not null]
  institution varchar(255) [not null]
  completion_date date [not null]
  certificate_number varchar(100)
  display_order integer [not null, default: 0]
  
  indexes {
    application_id
  }
  
  Note: 'Post-secondary qualifications (diplomas, degrees, certifications).'
}

Table employment_history {
  id uuid [pk, not null, default: `gen_random_uuid()`]
  application_id uuid [not null, ref: > application.id]
  employer varchar(255) [not null]
  role varchar(255) [not null]
  start_date date [not null]
  end_date date [note: 'NULL if currently employed']
  responsibilities text
  is_current boolean [not null, default: false]
  display_order integer [not null, default: 0]
  
  indexes {
    application_id
    is_current
  }
  
  Note: 'Work experience history. Used for mature-age entry assessments.'
}

// ============================================================================
// DOCUMENT MANAGEMENT
// ============================================================================

Table document_type {
  id uuid [pk, not null, default: `gen_random_uuid()`]
  code varchar(50) [unique, not null, note: 'e.g., PASSPORT, TRANSCRIPT, IELTS']
  name varchar(255) [not null]
  stage varchar(30) [not null, note: 'Which application stage requires this document']
  is_mandatory boolean [not null, default: false]
  ocr_model_ref varchar(100) [note: 'Azure Document Intelligence model ID']
  display_order integer [not null, default: 0]
  
  indexes {
    code [unique]
    stage
  }
  
  Note: 'Document type catalog. Pre-seeded with standard RTO requirements.'
}

Table document {
  id uuid [pk, not null, default: `gen_random_uuid()`]
  application_id uuid [not null, ref: > application.id]
  document_type_id uuid [not null, ref: > document_type.id]
  status varchar(20) [not null, default: 'pending', note: 'pending, verified, rejected, expired']
  uploaded_by uuid [not null, ref: > user_account.id]
  uploaded_at timestamp [not null, default: `now()`]
  ocr_status varchar(20) [not null, default: 'not_started', note: 'not_started, processing, completed, failed']
  ocr_completed_at timestamp
  gs_document_requests jsonb [note: 'Array of GS document requests with requested_by, requested_at, due_at, status (replaces GS_DOCUMENT_REQUEST table)']
  
  indexes {
    application_id
    document_type_id
    uploaded_by
    uploaded_at
    status
    ocr_status
    (gs_document_requests) [type: gin, name: 'idx_document_gs_requests']
  }
  
  Note: '''
    Document metadata and OCR status. Actual files stored in Azure Blob.
    JSONB field consolidates GS document request tracking.
  '''
}

Table document_version {
  id uuid [pk, not null, default: `gen_random_uuid()`]
  document_id uuid [not null, ref: > document.id]
  blob_url text [not null, note: 'Azure Blob Storage URL']
  checksum varchar(64) [not null, note: 'SHA-256 hash for integrity']
  ocr_json jsonb [note: 'Azure Document Intelligence output']
  preview_url text [note: 'Thumbnail/preview image URL']
  created_at timestamp [not null, default: `now()`]
  version_number integer [not null, default: 1]
  file_size_bytes bigint [not null]
  
  indexes {
    document_id
    version_number
    created_at
  }
  
  Note: 'Immutable document version history. Each edit creates new version.'
}

// ============================================================================
// ACTIVITY TIMELINE & AUDIT
// ============================================================================

Table timeline_entry {
  id uuid [pk, not null, default: `gen_random_uuid()`]
  application_id uuid [not null, ref: > application.id]
  entry_type varchar(30) [not null, note: 'APPLICATION_CREATED, STAGE_CHANGED, DOCUMENT_UPLOADED, COMMENT_ADDED, etc.']
  actor_id uuid [ref: > user_account.id]
  actor_role varchar(20) [note: 'STUDENT, AGENT, STAFF, ADMIN, SYSTEM']
  message text [not null]
  stage varchar(30) [note: 'Application stage at time of event']
  linked_document_id uuid [ref: > document.id]
  event_payload jsonb [note: 'Flexible event metadata (replaces WORKFLOW_EVENT table)']
  correlation_id varchar(100) [note: 'Groups related events (e.g., batch document upload)']
  created_at timestamp [not null, default: `now()`]
  is_pinned boolean [not null, default: false]
  
  indexes {
    application_id
    created_at
    entry_type
    actor_id
    correlation_id [name: 'idx_timeline_correlation', note: 'Partial index: WHERE correlation_id IS NOT NULL']
    (event_payload) [type: gin, name: 'idx_timeline_event_payload']
  }
  
  Note: '''
    User-facing activity feed for applications.
    JSONB event_payload absorbs WORKFLOW_EVENT table data.
    High-volume time-series data - partitioning recommended at scale.
  '''
}

Table audit_log {
  id uuid [pk, not null, default: `gen_random_uuid()`]
  entity_type varchar(50) [not null, note: 'APPLICATION, DOCUMENT, USER_ACCOUNT, etc.']
  entity_id uuid [not null]
  action varchar(50) [not null, note: 'CREATE, UPDATE, DELETE, LOGIN, etc.']
  actor_id uuid [ref: > user_account.id]
  ip_address varchar(45) [note: 'IPv4 or IPv6']
  payload_json jsonb [note: 'Full change payload for compliance']
  timestamp timestamp [not null, default: `now()`]
  
  indexes {
    entity_type
    entity_id
    actor_id
    timestamp
    (entity_type, entity_id, timestamp)
  }
  
  Note: '''
    Immutable compliance audit trail (superset of TIMELINE_ENTRY).
    Captures all system changes with full payload.
    Recommend partitioning by month for retention management.
  '''
}

// ============================================================================
// REFERENCE DATA (ENUMS)
// ============================================================================

Enum user_role {
  STUDENT
  AGENT
  STAFF
  ADMIN
}

Enum user_status {
  active
  inactive
  suspended
}

Enum application_stage {
  DRAFT
  SUBMITTED
  STAFF_REVIEW
  DOCUMENT_VERIFICATION
  GS_INTERVIEW
  OFFER_GENERATED
  OFFER_SIGNED
  ENROLLED
  REJECTED
  WITHDRAWN
}

Enum document_status {
  pending
  verified
  rejected
  expired
}

Enum ocr_status {
  not_started
  processing
  completed
  failed
}

Enum timeline_entry_type {
  APPLICATION_CREATED
  STAGE_CHANGED
  DOCUMENT_UPLOADED
  DOCUMENT_VERIFIED
  COMMENT_ADDED
  ASSIGNMENT_CHANGED
  GS_INTERVIEW_SCHEDULED
  OFFER_GENERATED
  OFFER_SIGNED
  ENROLLMENT_CONFIRMED
}
